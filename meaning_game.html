<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëœ» ë³´ê³  ë‹¨ì–´ ì°¾ê¸°</title>
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="config.js"></script>
    <script src="user-theme.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', 'ë§‘ì€ ê³ ë”•', Arial, sans-serif;
      background: var(--user-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      margin: 0;
      color: #333;
      font-size: 1.3rem;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      padding: 40px 24px 32px 24px;
      max-width: 600px;
      width: 100%;
      margin: 80px auto 32px auto;
    }
    
    .back-btn { 
      background: var(--user-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
      color: white; 
      border: none; 
      padding: 10px 15px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 14px; 
      transition: background 0.3s;
    }
    
    .back-btn:hover {
      background: #667eea;
    }
    .game-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: #f8f9fa; padding: 16px; border-radius: 12px; }
    .score, .round { background: #fff; padding: 8px 18px; border-radius: 8px; box-shadow: 0 2px 8px #0001; font-weight: bold; }
    .score { color: #28a745; } .round { color: #007bff; }
    .question-area { background: #f8f9fa; padding: 24px; border-radius: 12px; margin-bottom: 18px; text-align: center; }
    .question-text { font-size: 1.3rem; font-weight: bold; color: #333; margin-bottom: 18px; }
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 18px; }
    .option-btn { background: #fff; border: 2.5px solid #e9ecef; padding: 18px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; min-height: 60px; }
    .option-btn.selected { border-color: var(--user-primary-color, #667eea); background: var(--user-primary-color, #667eea); color: #fff; }
    .option-btn.correct { border-color: #28a745; background: #28a745; color: #fff; }
    .option-btn.incorrect { border-color: #dc3545; background: #dc3545; color: #fff; }
    .action-buttons { display: flex; gap: 12px; justify-content: center; margin-top: 10px; }
    .btn { padding: 10px 22px; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--user-gradient, #007bff) !important; color: #fff; }
    .btn-primary:disabled { background: #6c757d; cursor: not-allowed; }
    .btn-success { background: var(--play-btn-gradient, #28a745) !important; color: #fff; }
    .result-message { font-size: 1.1rem; font-weight: bold; margin: 16px 0; padding: 10px; border-radius: 8px; }
    .result-correct { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .result-incorrect { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    @media (max-width: 600px) { 
        .container { 
            padding: 20px 15px; 
            margin: 70px auto 20px auto;
        } 
        .header {
            padding: 12px 15px;
        }
        .header h1 { 
            font-size: 1.2rem; 
        } 
        .header-buttons {
            gap: 8px;
        }
        .back-btn {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        .options-grid { gap: 6px; } 
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ëœ» ë³´ê³  ë‹¨ì–´ ì°¾ê¸°</h1>
    <div class="header-buttons">
      <button class="back-btn" onclick="goBack()">â† í™ˆìœ¼ë¡œ</button>
    </div>
  </div>
  <div class="container">
    <div id="setSelectArea" style="margin-bottom:24px; text-align:center;"></div>
    <div class="game-info">
      <div class="score">ì ìˆ˜: <span id="score">0</span></div>
      <div class="round">ë¼ìš´ë“œ: <span id="round">1</span>/5</div>
    </div>
    <div class="question-area">
      <div class="question-text" id="questionText">ëœ»ì„ ë³´ê³  ì•Œë§ì€ ì˜ì–´ ë‹¨ì–´ë¥¼ ê³ ë¥´ì„¸ìš”!</div>
      <div class="options-grid" id="optionsGrid"></div>
      <div class="action-buttons">
        <button class="btn btn-primary" id="checkBtn" onclick="checkAnswer()" disabled>ì •ë‹µ í™•ì¸</button>
        <button class="btn btn-success" id="nextBtn" onclick="nextRound()" disabled>ë‹¤ìŒ</button>
      </div>
      <div class="result-message" id="resultMessage" style="display:none;"></div>
    </div>
    <div id="successPopup" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:1000;">
      <div style="background:white; border-radius:20px; padding:40px; max-width:350px; margin:auto; text-align:center;">
        <h2>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
        <div style="margin:18px 0; font-size:1.1rem;">í‰ê·  80ì  ì´ìƒìœ¼ë¡œ ëª¨ë“  ì„¸íŠ¸ë¥¼ ì™„ë£Œí–ˆì–´ìš”!</div>
        <button class="btn btn-success" onclick="closeSuccessPopup()">í™•ì¸</button>
        <div id="videoArea" style="margin-top:20px; display:none;"></div>
      </div>
    </div>
  </div>
  <script>
    // ê¶Œí•œ í™•ì¸
    function checkPermission() {
        // getCurrentUser í•¨ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if (typeof getCurrentUser === 'undefined') {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = 'index.html';
            return false;
        }
        
        const currentUser = getCurrentUser();
        if (!currentUser) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = 'index.html';
            return false;
        }
        
        return true;
    }
    
    // íŒŒë‹‰ìŠ¤ í•™ìŠµ ë°ì´í„° (ë‹¨ëª¨ìŒ ë‹¨ì–´ë“¤ê³¼ ëœ»)
    const phonicsData = {
        'a': [
            { word: 'cat', meaning: 'ê³ ì–‘ì´' },
            { word: 'hat', meaning: 'ëª¨ì' },
            { word: 'bat', meaning: 'ë°•ì¥' },
            { word: 'rat', meaning: 'ì¥' },
            { word: 'mat', meaning: 'ë§¤íŠ¸' },
            { word: 'sat', meaning: 'ì•‰ì•˜ë‹¤' },
            { word: 'fat', meaning: 'ëš±ëš±í•œ' },
            { word: 'pat', meaning: 'ê°€ë³ê²Œ ì¹˜ë‹¤' },
            { word: 'map', meaning: 'ì§€ë„' },
            { word: 'cap', meaning: 'ëª¨ì' },
            { word: 'tap', meaning: 'ê°€ë³ê²Œ ì¹˜ë‹¤' },
            { word: 'lap', meaning: 'ë¬´ë¦' },
            { word: 'bag', meaning: 'ê°€ë°©' },
            { word: 'tag', meaning: 'ê¼¬ë¦¬í‘œ' },
            { word: 'rag', meaning: 'ê±¸ë ˆ' }
        ],
        'e': [
            { word: 'bed', meaning: 'ì¹¨ëŒ€' },
            { word: 'red', meaning: 'ë¹¨ê°„' },
            { word: 'fed', meaning: 'ë¨¹ì˜€ë‹¤' },
            { word: 'led', meaning: 'ì´ëŒì—ˆë‹¤' },
            { word: 'get', meaning: 'ì–»ë‹¤' },
            { word: 'let', meaning: 'í—ˆë½í•˜ë‹¤' },
            { word: 'met', meaning: 'ë§Œë‚¬ë‹¤' },
            { word: 'net', meaning: 'ê·¸ë¬¼' },
            { word: 'pet', meaning: 'ì• ì™„ë™ë¬¼' },
            { word: 'set', meaning: 'ë†“ë‹¤' },
            { word: 'wet', meaning: 'ì –ì€' },
            { word: 'bet', meaning: 'ë‚´ê¸°í•˜ë‹¤' },
            { word: 'jet', meaning: 'ì œíŠ¸ê¸°' },
            { word: 'vet', meaning: 'ìˆ˜ì˜ì‚¬' },
            { word: 'den', meaning: 'êµ´' },
            { word: 'hen', meaning: 'ì•”íƒ‰' },
            { word: 'men', meaning: 'ë‚¨ìë“¤' },
            { word: 'pen', meaning: 'íœ' },
            { word: 'ten', meaning: 'ì—´' }
        ],
        'i': [
            { word: 'big', meaning: 'í°' },
            { word: 'dig', meaning: 'íŒŒë‹¤' },
            { word: 'fig', meaning: 'ë¬´í™”ê³¼' },
            { word: 'pig', meaning: 'ë¼ì§€' },
            { word: 'rig', meaning: 'ì¥ë¹„' },
            { word: 'wig', meaning: 'ê°€ë°œ' },
            { word: 'bit', meaning: 'ì¡°ê¸ˆ' },
            { word: 'fit', meaning: 'ë§ë‹¤' },
            { word: 'hit', meaning: 'ì¹˜ë‹¤' },
            { word: 'kit', meaning: 'ë„êµ¬ìƒì' },
            { word: 'lit', meaning: 'ë°í˜”ë‹¤' },
            { word: 'pit', meaning: 'êµ¬ë©ì´' },
            { word: 'sit', meaning: 'ì•‰ë‹¤' },
            { word: 'wit', meaning: 'ì¬ì¹˜' },
            { word: 'bin', meaning: 'í†µ' },
            { word: 'din', meaning: 'ì†ŒìŒ' },
            { word: 'fin', meaning: 'ì§€ëŠëŸ¬ë¯¸' },
            { word: 'pin', meaning: 'í•€' },
            { word: 'sin', meaning: 'ì£„' },
            { word: 'tin', meaning: 'ì£¼ì„' },
            { word: 'win', meaning: 'ì´ê¸°ë‹¤' }
        ],
        'o': [
            { word: 'dog', meaning: 'ê°œ' },
            { word: 'fog', meaning: 'ì•ˆê°œ' },
            { word: 'hog', meaning: 'ë¼ì§€' },
            { word: 'jog', meaning: 'ì¡°ê¹…í•˜ë‹¤' },
            { word: 'log', meaning: 'í†µë‚˜ë¬´' },
            { word: 'got', meaning: 'ì–»ì—ˆë‹¤' },
            { word: 'hot', meaning: 'ëœ¨ê±°ìš´' },
            { word: 'lot', meaning: 'ë§ì´' },
            { word: 'not', meaning: 'ì•„ë‹ˆë‹¤' },
            { word: 'pot', meaning: 'ëƒ„ë¹„' },
            { word: 'rot', meaning: 'ì©ë‹¤' },
            { word: 'tot', meaning: 'ì•„ê¸°' },
            { word: 'dot', meaning: 'ì ' },
            { word: 'cot', meaning: 'ê°„ì´ì¹¨ëŒ€' },
            { word: 'bot', meaning: 'ë¡œë´‡' },
            { word: 'box', meaning: 'ìƒì' },
            { word: 'fox', meaning: 'ì—¬ìš°' },
            { word: 'pox', meaning: 'ì²œì—°ë‘' },
            { word: 'sox', meaning: 'ì–‘ë§' },
            { word: 'cox', meaning: 'ì¡°íƒ€ìˆ˜' }
        ],
        'u': [
            { word: 'bug', meaning: 'ë²Œë ˆ' },
            { word: 'hug', meaning: 'ì•ˆì•„ì£¼ë‹¤' },
            { word: 'jug', meaning: 'ì£¼ì „ì' },
            { word: 'mug', meaning: 'ë¨¸ê·¸ì»µ' },
            { word: 'rug', meaning: 'ëŸ¬ê·¸' },
            { word: 'tug', meaning: 'ëŒë‹¤' },
            { word: 'dug', meaning: 'íŒ ë‹¤' },
            { word: 'lug', meaning: 'ëŒë‹¤' },
            { word: 'pug', meaning: 'í¼ê·¸' },
            { word: 'sug', meaning: 'ì„¤íƒ•' },
            { word: 'but', meaning: 'í•˜ì§€ë§Œ' },
            { word: 'cut', meaning: 'ìë¥´ë‹¤' },
            { word: 'gut', meaning: 'ì°½ì' },
            { word: 'hut', meaning: 'ì˜¤ë‘ë§‰' },
            { word: 'jut', meaning: 'íŠ€ì–´ë‚˜ì˜¤ë‹¤' },
            { word: 'nut', meaning: 'ê²¬ê³¼ë¥˜' },
            { word: 'put', meaning: 'ë†“ë‹¤' },
            { word: 'rut', meaning: 'ê³ ë‘' },
            { word: 'tut', meaning: 'í¥' },
            { word: 'bun', meaning: 'ë¹µ' },
            { word: 'fun', meaning: 'ì¬ë¯¸' },
            { word: 'gun', meaning: 'ì´' },
            { word: 'nun', meaning: 'ìˆ˜ë…€' },
            { word: 'pun', meaning: 'ë§ì¥ë‚œ' },
            { word: 'run', meaning: 'ë‹¬ë¦¬ë‹¤' },
            { word: 'sun', meaning: 'íƒœì–‘' },
            { word: 'tun', meaning: 'í° í†µ' },
            { word: 'cub', meaning: 'ìƒˆë¼' },
            { word: 'hub', meaning: 'ì¤‘ì‹¬' },
            { word: 'pub', meaning: 'ìˆ ì§‘' },
            { word: 'rub', meaning: 'ë¬¸ì§€ë¥´ë‹¤' },
            { word: 'tub', meaning: 'ìš•ì¡°' }
        ]
    };
    
    // í˜„ì¬ í•™ìŠµí•  ëª¨ìŒ ì„ íƒ (ë¼ìš´ë“œë³„ë¡œ ë‹¤ë¥¸ ëª¨ìŒ)
    function getCurrentVowel(round) {
        const vowels = ['a', 'e', 'i', 'o', 'u'];
        return vowels[(round - 1) % vowels.length];
    }
    
    // í˜„ì¬ ë¼ìš´ë“œì˜ ë‹¨ì–´ë“¤ ê°€ì ¸ì˜¤ê¸°
    function getCurrentWords(round) {
        const vowel = getCurrentVowel(round);
        return phonicsData[vowel];
    }
    let selected = null;
    const TOTAL_ROUNDS = 5;

    let currentSet = null;
    let currentRound = 0;
    let score = 0;
    const ROUNDS_PER_SET = 5;
    const TOTAL_SETS = 3;
    let setScores = JSON.parse(localStorage.getItem('meaningSetScores') || '[0,0,0]');
    let clearedSets = JSON.parse(localStorage.getItem('meaningClearedSets') || '[false,false,false]');

    function renderSetSelect() {
      const area = document.getElementById('setSelectArea');
      let html = '<div style="margin-bottom:10px; font-weight:600;">ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>';
      for(let i=1;i<=TOTAL_SETS;i++) {
        html += `<button class="btn" style="margin:0 8px 8px 0; min-width:80px;${clearedSets[i-1] ? 'background:#ccc;cursor:not-allowed;' : ''}" onclick="startSet(${i})" ${clearedSets[i-1] ? 'disabled' : ''}>${i}ì„¸íŠ¸${clearedSets[i-1] ? ' (ì™„ë£Œ)' : ''}</button>`;
      }
      html += '<button class="btn btn-secondary" style="margin-left:10px;" onclick="resetSets()">ì„¸íŠ¸ ì´ˆê¸°í™”</button>';
      area.innerHTML = html;
      document.querySelector('.game-info').style.display = 'none';
      document.querySelector('.question-area').style.display = 'none';
    }
    function startSet(setNum) {
      currentSet = setNum;
      currentRound = 0;
      score = 0;
      document.getElementById('score').textContent = score;
      document.getElementById('round').textContent = currentRound+1;
      document.querySelector('.game-info').style.display = '';
      document.querySelector('.question-area').style.display = '';
      document.getElementById('setSelectArea').innerHTML = '';
      renderQuestion();
    }
    function resetSets() {
      if(confirm('ì •ë§ ëª¨ë“  ì„¸íŠ¸ ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) {
        setScores = [0,0,0];
        clearedSets = [false,false,false];
        localStorage.setItem('meaningSetScores', JSON.stringify(setScores));
        localStorage.setItem('meaningClearedSets', JSON.stringify(clearedSets));
        renderSetSelect();
      }
    }
    function renderQuestion() {
      document.getElementById('round').textContent = currentRound+1;
      document.getElementById('score').textContent = score;
      // í˜„ì¬ ë¼ìš´ë“œì— ë§ëŠ” ëª¨ìŒê³¼ ë‹¨ì–´ ì„ íƒ
      const currentVowel = getCurrentVowel(currentRound + 1);
      const currentWords = getCurrentWords(currentRound + 1);
      const randomWordData = currentWords[Math.floor(Math.random() * currentWords.length)];
      document.getElementById('questionText').textContent = `ëœ»: ${randomWordData.meaning}`;
      // í˜„ì¬ í•™ìŠµ ì¤‘ì¸ ëª¨ìŒ í‘œì‹œ
      console.log(`ì„¸íŠ¸${currentSet} ë¼ìš´ë“œ${currentRound + 1}: ëª¨ìŒ '${currentVowel}' í•™ìŠµ ì¤‘ - ë‹¨ì–´: ${randomWordData.word} (${randomWordData.meaning})`);
      const grid = document.getElementById('optionsGrid');
      grid.innerHTML = '';
      // ì„ íƒì§€ ìƒì„± (ì •ë‹µ + ë‹¤ë¥¸ ë‹¨ì–´ë“¤)
      const options = [randomWordData.word];
      const allWords = Object.values(phonicsData).flat().map(item => item.word);
      const otherWords = allWords.filter(word => word !== randomWordData.word);
      for (let i = 0; i < 3; i++) {
        const randomWord = otherWords[Math.floor(Math.random() * otherWords.length)];
        if (!options.includes(randomWord)) {
          options.push(randomWord);
        }
      }
      // ì„ íƒì§€ ì„ê¸°
      for (let i = options.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [options[i], options[j]] = [options[j], options[i]];
      }
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt;
        btn.onclick = () => selectOption(btn, opt);
        grid.appendChild(btn);
      });
      selected = null;
      document.getElementById('checkBtn').disabled = true;
      document.getElementById('nextBtn').disabled = true;
      document.getElementById('resultMessage').style.display = 'none';
    }
    function nextRound() {
      currentRound++;
      if (currentRound >= ROUNDS_PER_SET) {
        setScores[currentSet-1] = score;
        clearedSets[currentSet-1] = true;
        localStorage.setItem('meaningSetScores', JSON.stringify(setScores));
        localStorage.setItem('meaningClearedSets', JSON.stringify(clearedSets));
        // í‰ê·  ì ìˆ˜ ê³„ì‚°
        const clearedCount = clearedSets.filter(Boolean).length;
        const avg = setScores.reduce((a,b)=>a+b,0) / clearedCount;
        if (clearedCount === TOTAL_SETS && avg >= 80) {
          showSuccessPopup(avg);
        } else {
          alert(`ì„¸íŠ¸ ì™„ë£Œ! ì ìˆ˜: ${score}`);
          renderSetSelect();
        }
        return;
      }
      renderQuestion();
    }
    function showSuccessPopup(avg) {
      document.getElementById('successPopup').style.display = 'flex';
      document.getElementById('videoArea').style.display = 'block';
      document.getElementById('videoArea').innerHTML = '<iframe width="300" height="170" src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>';
    }
    function closeSuccessPopup() {
      document.getElementById('successPopup').style.display = 'none';
      renderSetSelect();
    }
    // ìµœì´ˆ ì§„ì… ì‹œ ì„¸íŠ¸ ì„ íƒ
    window.onload = function() {
      if (checkPermission()) {
        renderSetSelect();
      }
    };
  </script>
</body>
</html> 